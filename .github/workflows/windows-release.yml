name: Windows Release Pipeline

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a GitHub release'
        required: false
        default: false
        type: boolean
      version:
        description: 'Version string (e.g., 0.2.0-beta)'
        required: false
        default: ''
        type: string
      include_tripsitter:
        description: 'Include TripSitter.exe (requires self-hosted runner)'
        required: false
        default: false
        type: boolean

env:
  BUILD_TYPE: Release

jobs:
  # Stage 1: Build backend DLL on GitHub-hosted runner
  build-backend:
    name: Build Backend DLL
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '25b458671af03578e6a34edd8f0d1ac85e084df4'

      - name: Configure CMake
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_OVERLAY_TRIPLETS="${{ github.workspace }}/triplets" `
            -DBUILD_TESTS=OFF
        shell: powershell

      - name: Build Backend
        run: cmake --build build --config ${{ env.BUILD_TYPE }} --target beatsync_backend_shared -- /m
        shell: powershell

      - name: Upload Backend Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-dlls
          path: |
            build/Release/*.dll
            build/vcpkg_installed/x64-windows/bin/onnxruntime*.dll

  # Stage 2: Build TripSitter.exe on self-hosted runner with UE5
  # This job only runs when explicitly requested or on tag pushes with self-hosted runner available
  build-tripsitter:
    name: Build TripSitter GUI
    needs: build-backend
    runs-on: [self-hosted, windows, ue5]
    if: github.event.inputs.include_tripsitter == 'true' || startsWith(github.ref, 'refs/tags/v')
    continue-on-error: true  # Don't fail entire workflow if UE5 runner unavailable

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Backend
        uses: actions/download-artifact@v4
        with:
          name: backend-dlls
          path: build/Release

      - name: Deploy DLLs to UE5
        run: |
          $ue5Bin = "C:\UE5_Source\UnrealEngine\Engine\Binaries\Win64"

          # Copy backend DLLs
          Copy-Item 'build\Release\beatsync_backend_shared.dll' $ue5Bin -Force
          Copy-Item 'build\Release\onnxruntime.dll' $ue5Bin -Force -ErrorAction SilentlyContinue

          # Copy FFmpeg DLLs from ThirdParty
          Copy-Item 'unreal-prototype\ThirdParty\beatsync\lib\x64\av*.dll' $ue5Bin -Force
          Copy-Item 'unreal-prototype\ThirdParty\beatsync\lib\x64\sw*.dll' $ue5Bin -Force

          Write-Host "DLLs deployed to $ue5Bin"
        shell: powershell

      - name: Sync Source to UE5
        run: |
          $dest = "C:\UE5_Source\UnrealEngine\Engine\Source\Programs\TripSitter\Private"
          if (-not (Test-Path $dest)) {
            New-Item -ItemType Directory -Path $dest -Force | Out-Null
          }
          Copy-Item -Path 'unreal-prototype\Source\TripSitter\Private\*' -Destination $dest -Recurse -Force
          Write-Host "Source synced to UE5"
        shell: powershell

      - name: Build TripSitter
        run: |
          & "C:\UE5_Source\UnrealEngine\Engine\Build\BatchFiles\Build.bat" TripSitter Win64 Development
        shell: powershell

      - name: Upload TripSitter Executable
        uses: actions/upload-artifact@v4
        with:
          name: tripsitter-exe
          path: C:\UE5_Source\UnrealEngine\Engine\Binaries\Win64\TripSitter.exe

  # Stage 3: Create installer packages
  # Waits for both build-backend and build-tripsitter (if running) to complete
  package-and-sign:
    name: Package & Sign (Windows)
    needs: [build-backend, build-tripsitter]
    if: ${{ always() && needs.build-backend.result == 'success' }}
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build tools
        run: |
          choco install -y nsis 7zip
          $nsisPath = "C:\Program Files (x86)\NSIS"
          if (Test-Path $nsisPath) {
            echo "$nsisPath" >> $env:GITHUB_PATH
          }
        shell: powershell

      - name: Verify NSIS installation
        run: |
          $makensis = Get-Command makensis -ErrorAction SilentlyContinue | Select-Object -ExpandProperty Source
          if (-not $makensis) {
            Write-Error "makensis not found in PATH"
            exit 1
          }
          Write-Host "Found makensis at: $makensis"
          & $makensis /VERSION
        shell: powershell

      - name: Download Backend Artifacts
        uses: actions/download-artifact@v4
        with:
          name: backend-dlls
          path: build/Release

      - name: Download TripSitter (if available)
        uses: actions/download-artifact@v4
        with:
          name: tripsitter-exe
          path: staging/bin
        continue-on-error: true

      - name: Setup vcpkg (for CMake configuration)
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: '25b458671af03578e6a34edd8f0d1ac85e084df4'

      - name: Configure CMake for Packaging
        run: |
          # Check if TripSitter.exe was downloaded
          $tripSitterPath = "staging/bin/TripSitter.exe"
          if (Test-Path $tripSitterPath) {
            $tripSitterArg = "-DTRIPSITTER_EXE_PATH=${{ github.workspace }}/staging/bin/TripSitter.exe"
            Write-Host "TripSitter.exe found - will be included in installer"
          } else {
            $tripSitterArg = ""
            Write-Warning "TripSitter.exe not found - installer will not include main GUI"
          }

          cmake -S . -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DCMAKE_TOOLCHAIN_FILE="${{ github.workspace }}/vcpkg/scripts/buildsystems/vcpkg.cmake" `
            -DVCPKG_OVERLAY_TRIPLETS="${{ github.workspace }}/triplets" `
            -DBUILD_TESTS=OFF `
            $tripSitterArg
        shell: powershell

      - name: Check certificate availability
        id: cert-check
        env:
          CERT: ${{ secrets.CODESIGN_CERTIFICATE_BASE64 }}
        run: |
          if ($env:CERT) {
            "has_cert=true" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            "has_cert=false" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }
        shell: powershell

      - name: Sign binaries (if certificate available)
        if: steps.cert-check.outputs.has_cert == 'true'
        env:
          CODESIGN_CERTIFICATE_BASE64: ${{ secrets.CODESIGN_CERTIFICATE_BASE64 }}
          CODESIGN_CERTIFICATE_PASSWORD: ${{ secrets.CODESIGN_CERTIFICATE_PASSWORD }}
        run: |
          pwsh -NoProfile -ExecutionPolicy Bypass -File ./scripts/sign-windows-binaries.ps1 `
            -BuildDir "build/Release"
        shell: powershell

      - name: Generate installer (CPack)
        run: |
          cd build
          cpack -C ${{ env.BUILD_TYPE }} -G NSIS
          cpack -C ${{ env.BUILD_TYPE }} -G ZIP
        shell: powershell

      - name: Sign installer (if certificate available)
        if: steps.cert-check.outputs.has_cert == 'true'
        env:
          CODESIGN_CERTIFICATE_BASE64: ${{ secrets.CODESIGN_CERTIFICATE_BASE64 }}
          CODESIGN_CERTIFICATE_PASSWORD: ${{ secrets.CODESIGN_CERTIFICATE_PASSWORD }}
        run: |
          $installer = Get-ChildItem -Path build -Filter "*.exe" |
            Where-Object { $_.Name -like "*TripSitter*" -or $_.Name -like "*MTV*" } |
            Where-Object { $_.Name -notlike "*uninstall*" -and $_.Name -notlike "*Uninstall*" } |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 1
          if ($installer) {
            pwsh -NoProfile -ExecutionPolicy Bypass -File ./scripts/sign-windows-binaries.ps1 -InstallerPath $installer.FullName
          } else {
            Write-Warning "No installer executable found to sign"
          }
        shell: powershell

      - name: List build artifacts
        run: |
          Write-Host "=== Build Output ===" -ForegroundColor Cyan
          Get-ChildItem -Path build -Recurse -File |
            Where-Object { $_.Extension -in '.exe', '.zip', '.dll' } |
            Format-Table Name, Length, LastWriteTime
        shell: powershell

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: mtv-tripsitter-installer
          path: build/*.exe
          if-no-files-found: warn

      - name: Upload ZIP package
        uses: actions/upload-artifact@v4
        with:
          name: mtv-tripsitter-zip
          path: build/*.zip
          if-no-files-found: warn

  smoke-test:
    name: Installer Smoke Test
    needs: package-and-sign
    runs-on: windows-latest

    steps:
      - name: Download installer
        uses: actions/download-artifact@v4
        with:
          name: mtv-tripsitter-installer
          path: installers

      - name: List downloaded artifacts
        run: Get-ChildItem -Path installers -Recurse
        shell: powershell

      - name: Run silent installation
        run: |
          $installer = Get-ChildItem -Path installers -Filter "*.exe" | Select-Object -First 1
          if (-not $installer) {
            Write-Error "No installer found - packaging may have failed"
            exit 1
          }

          Write-Host "Installing: $($installer.FullName)"

          # Run silent installation with timeout
          $proc = Start-Process -FilePath $installer.FullName -ArgumentList "/S" -PassThru
          $timeoutMs = 600000  # 10 minutes
          $waitResult = $proc.WaitForExit($timeoutMs)
          if (-not $waitResult) {
            Write-Error "Installer did not finish within $($timeoutMs / 60000) minutes. Killing process and failing job."
            try { $proc.Kill() } catch {}
            exit 1
          }
          if ($proc.ExitCode -ne 0) {
            Write-Error "Installation failed with exit code: $($proc.ExitCode)"
            exit 1
          }

          Write-Host "Installation completed successfully"
        shell: powershell

      - name: Verify installation structure
        run: |
          $installPath = "$env:ProgramFiles\MTV TripSitter"

          # Check if install directory exists
          if (-not (Test-Path $installPath)) {
            Write-Error "Installation directory not found: $installPath"
            exit 1
          }

          Write-Host "Installation directory found: $installPath"
          Write-Host "`n=== Installation Contents ===" -ForegroundColor Cyan
          Get-ChildItem -Path $installPath -Recurse | Format-Table Name, Length

          # Verify expected directories
          $expectedDirs = @("bin", "licenses")
          $optionalDirs = @("models", "resources")

          foreach ($dir in $expectedDirs) {
            $dirPath = Join-Path $installPath $dir
            if (Test-Path $dirPath) {
              Write-Host "[OK] Required directory exists: $dir" -ForegroundColor Green
            } else {
              Write-Error "Required directory missing: $dir"
              exit 1
            }
          }

          foreach ($dir in $optionalDirs) {
            $dirPath = Join-Path $installPath $dir
            if (Test-Path $dirPath) {
              Write-Host "[OK] Optional directory exists: $dir" -ForegroundColor Green
            } else {
              Write-Host "[INFO] Optional directory not present: $dir" -ForegroundColor Yellow
            }
          }
        shell: powershell

      - name: Verify TripSitter.exe
        run: |
          $installPath = "$env:ProgramFiles\MTV TripSitter"
          $tripSitterExe = Join-Path $installPath "bin\TripSitter.exe"

          if (Test-Path $tripSitterExe) {
            Write-Host "[OK] TripSitter.exe found" -ForegroundColor Green
            $exeInfo = Get-Item $tripSitterExe
            Write-Host "  Size: $([math]::Round($exeInfo.Length / 1MB, 2)) MB"

            # Brief launch test
            Write-Host "Starting smoke test launch..."
            $proc = Start-Process -FilePath $tripSitterExe -PassThru

            $smokeTestTimeout = 30
            $pollInterval = 2
            $elapsed = 0

            Write-Host "Waiting up to ${smokeTestTimeout}s for application to initialize..."
            while ($elapsed -lt $smokeTestTimeout -and -not $proc.HasExited) {
              Start-Sleep -Seconds $pollInterval
              $elapsed += $pollInterval
              Write-Host "  ... ${elapsed}s elapsed, process still running"
            }

            if ($proc.HasExited) {
              Write-Warning "Application exited during smoke test (exit code: $($proc.ExitCode))"
            } else {
              Write-Host "[OK] Application running successfully after ${elapsed}s" -ForegroundColor Green
              Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue
            }
          } else {
            Write-Warning "TripSitter.exe not found - this is expected if UE5 build was skipped"

            # Check for any executable in bin
            $anyExe = Get-ChildItem -Path (Join-Path $installPath "bin") -Filter "*.exe" -ErrorAction SilentlyContinue |
              Where-Object { $_.Name -notlike "*uninstall*" } |
              Select-Object -First 1

            if ($anyExe) {
              Write-Host "[INFO] Found alternative executable: $($anyExe.Name)" -ForegroundColor Yellow
            }
          }
        shell: powershell

      - name: Verify license files
        run: |
          $installPath = "$env:ProgramFiles\MTV TripSitter"
          $licensesDir = Join-Path $installPath "licenses"

          if (Test-Path $licensesDir) {
            $licenseFile = Join-Path $licensesDir "LICENSE"
            $thirdPartyFile = Join-Path $licensesDir "THIRD_PARTY_LICENSES.md"

            if (Test-Path $licenseFile) {
              Write-Host "[OK] LICENSE file present" -ForegroundColor Green
              # Verify it's not the placeholder
              $content = Get-Content $licenseFile -First 1
              if ($content -like "*MIT License*") {
                Write-Host "[OK] LICENSE contains MIT license text" -ForegroundColor Green
              } elseif ($content -like "*Placeholder*") {
                Write-Error "LICENSE file is still a placeholder!"
                exit 1
              }
            } else {
              Write-Warning "LICENSE file not found"
            }

            if (Test-Path $thirdPartyFile) {
              Write-Host "[OK] THIRD_PARTY_LICENSES.md present" -ForegroundColor Green
            } else {
              Write-Warning "THIRD_PARTY_LICENSES.md not found"
            }
          } else {
            Write-Warning "licenses directory not found"
          }
        shell: powershell

      - name: Verify required DLLs
        run: |
          $binDir = "$env:ProgramFiles\MTV TripSitter\bin"

          if (-not (Test-Path $binDir)) {
            Write-Error "bin directory not found - installer may be incomplete"
            exit 1
          }

          $requiredDlls = @(
            "beatsync_backend_shared.dll"
          )

          $optionalDlls = @(
            "onnxruntime.dll",
            "avcodec-62.dll",
            "avformat-62.dll",
            "avutil-60.dll"
          )

          Write-Host "`n=== DLL Verification ===" -ForegroundColor Cyan

          foreach ($dll in $requiredDlls) {
            $dllPath = Join-Path $binDir $dll
            if (Test-Path $dllPath) {
              $size = [math]::Round((Get-Item $dllPath).Length / 1MB, 2)
              Write-Host "[OK] $dll ($size MB)" -ForegroundColor Green
            } else {
              Write-Error "Required DLL missing: $dll"
              exit 1
            }
          }

          foreach ($dll in $optionalDlls) {
            $dllPath = Join-Path $binDir $dll
            if (Test-Path $dllPath) {
              $size = [math]::Round((Get-Item $dllPath).Length / 1MB, 2)
              Write-Host "[OK] $dll ($size MB)" -ForegroundColor Green
            } else {
              Write-Host "[INFO] Optional DLL not present: $dll" -ForegroundColor Yellow
            }
          }
        shell: powershell

      - name: Run uninstallation
        run: |
          $uninstaller = "$env:ProgramFiles\MTV TripSitter\Uninstall.exe"

          if (Test-Path $uninstaller) {
            Write-Host "Running uninstaller..."
            $proc = Start-Process -FilePath $uninstaller -ArgumentList "/S" -PassThru -Wait
            Write-Host "Uninstaller exit code: $($proc.ExitCode)"

            # Verify cleanup
            $installPath = "$env:ProgramFiles\MTV TripSitter"
            if (-not (Test-Path $installPath)) {
              Write-Host "[OK] Installation directory removed" -ForegroundColor Green
            } else {
              $remaining = Get-ChildItem -Path $installPath -Recurse -ErrorAction SilentlyContinue
              if ($remaining) {
                Write-Warning "Some files remain after uninstall:"
                $remaining | Format-Table Name
              }
            }
          } else {
            Write-Warning "Uninstaller not found at: $uninstaller"
          }
        shell: powershell

      - name: Smoke test summary
        run: |
          Write-Host "`n=== Smoke Test Complete ===" -ForegroundColor Cyan
          Write-Host "All critical checks passed!" -ForegroundColor Green
        shell: powershell

  create-release:
    name: Create GitHub Release
    needs: [package-and-sign, smoke-test]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List artifacts
        run: find artifacts -type f -ls

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Generate checksums
        run: |
          cd artifacts
          : > checksums.txt
          found_files=0

          if compgen -G "mtv-tripsitter-installer/*.exe" > /dev/null; then
            for f in mtv-tripsitter-installer/*.exe; do
              sha256sum "$f" | sed 's|mtv-tripsitter-installer/||' >> checksums.txt
              found_files=1
            done
          fi

          if compgen -G "mtv-tripsitter-zip/*.zip" > /dev/null; then
            for f in mtv-tripsitter-zip/*.zip; do
              sha256sum "$f" | sed 's|mtv-tripsitter-zip/||' >> checksums.txt
              found_files=1
            done
          fi

          if [ "$found_files" -eq 0 ]; then
            echo "ERROR: No installer or zip files found for checksumming." | tee checksums.txt
            exit 1
          fi

          echo "Generated checksums:"
          cat checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: MTV TripSitter v${{ steps.version.outputs.version }}
          tag_name: v${{ steps.version.outputs.version }}
          draft: true
          prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') }}
          files: |
            artifacts/mtv-tripsitter-installer/*.exe
            artifacts/mtv-tripsitter-zip/*.zip
            artifacts/checksums.txt
          body: |
            ## MTV TripSitter v${{ steps.version.outputs.version }}

            ### Installation

            #### Windows Installer (Recommended)
            1. Download `MTVTripSitter-*.exe`
            2. Run the installer
            3. Follow the installation wizard
            4. Launch from Start Menu or Desktop shortcut

            #### Portable ZIP
            1. Download `MTVTripSitter-*.zip`
            2. Extract to your preferred location
            3. Run `bin/TripSitter.exe`

            ### System Requirements
            - Windows 10 or later (64-bit)
            - 4GB RAM minimum (8GB recommended)
            - NVIDIA GPU recommended for AI acceleration
              - RTX series: TensorRT acceleration
              - GTX series: CUDA acceleration
              - No GPU: CPU fallback (slower)

            ### Features
            - AI-powered beat detection (ONNX Runtime)
            - Multiple analysis modes: Energy, ONNX AI, Flux, Stems + Flux
            - Beat-synchronized video editing
            - Real-time waveform visualization
            - Customizable beat effects

            ### Checksums
            ```
            SHA256 checksums are included in checksums.txt
            ```

            ### Known Issues
            See [CHANGELOG.md](https://github.com/tripsitter-psy/tripsitters_audio_beatsync_GUI/blob/main/CHANGELOG.md) for details.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

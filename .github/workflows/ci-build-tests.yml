name: CI â€” Build & Tests

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ '**' ]

jobs:
  build-and-test:
    name: Build & Test (${{ matrix.os }})
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup vcpkg (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          VCPKG_ROOT=${{ runner.temp }}/vcpkg
          git clone https://github.com/microsoft/vcpkg.git "$VCPKG_ROOT"
          bash "$VCPKG_ROOT/bootstrap-vcpkg.sh"
          "$VCPKG_ROOT/vcpkg" install --triplet x64-linux
        env:
          VCPKG_ROOT: ${{ runner.temp }}/vcpkg

      - name: Setup vcpkg (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $env:VCPKG_ROOT = "$env:TEMP\vcpkg"
          git clone https://github.com/microsoft/vcpkg.git $env:VCPKG_ROOT
          & "$env:VCPKG_ROOT\bootstrap-vcpkg.bat"
          & "$env:VCPKG_ROOT\vcpkg" install --triplet x64-windows

      - name: Configure (CMake)
        run: |
          if [ "${{ matrix.os }}" = "ubuntu-latest" ]; then
            VCPKG_ROOT=${{ runner.temp }}/vcpkg
            cmake -S . -B build -DCMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" -DBUILD_TESTS=ON -DCMAKE_BUILD_TYPE=Release
          else
            pwsh -Command "$env:VCPKG_ROOT = \"$env:TEMP\\vcpkg\"; cmake -S . -B build -DCMAKE_TOOLCHAIN_FILE=\"$env:VCPKG_ROOT\\scripts\\buildsystems\\vcpkg.cmake\" -DBUILD_TESTS=ON -DCMAKE_BUILD_TYPE=Release"
          fi

      - name: Build
        run: |
          cmake --build build --config Release --parallel

      - name: Run tests
        id: run-tests
        continue-on-error: false
        run: |
          ctest --test-dir build -C Release --output-on-failure --parallel || exit 1

      # Always collect diagnostics and upload artifacts (FFmpeg logs and ctest output)
      - name: Collect FFmpeg logs and test output (Linux)
        if: always() && matrix.os == 'ubuntu-latest'
        run: |
          mkdir -p artifacts/ci_logs
          find . -type f -name 'beatsync_ffmpeg_*.log' -exec cp {} artifacts/ci_logs/ \; || true
          if [ -f build/Testing/Temporary/LastTest.log ]; then cp build/Testing/Temporary/LastTest.log artifacts/ci_logs/ctest_output.txt; fi

      - name: Collect FFmpeg logs and test output (Windows)
        if: always() && matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts\ci_logs | Out-Null
          Get-ChildItem -Path . -Filter 'beatsync_ffmpeg_*.log' -Recurse -ErrorAction SilentlyContinue | ForEach-Object { Copy-Item $_.FullName -Destination artifacts\ci_logs -Force }
          if (Test-Path build\Testing\Temporary\LastTest.log) { Copy-Item build\Testing\Temporary\LastTest.log artifacts\ci_logs\ctest_output.txt -Force }

      - name: Upload FFmpeg logs & test output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-logs-and-tests
          path: artifacts/ci_logs/**
          retention-days: 14

      - name: Upload build directory (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-directory
          path: build/**
          retention-days: 7

name: Build and Package (Windows)

on:
  push:
    branches: [ main ]
    tags: ['v*']
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-windows:
    name: Build TripSitter (Windows)
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Chocolatey packages (NSIS, 7zip)
        run: |
          choco install -y nsis
          choco install -y 7zip
        shell: powershell

      - name: Verify NSIS installation
        run: |
          Write-Host "Checking for makensis..."
          $mak = Get-Command makensis -ErrorAction SilentlyContinue
          if (-not $mak) {
            Write-Error "makensis not found in PATH; Chocolatey install may have failed."
            exit 1
          }
          makensis -VERSION
        shell: powershell

      - name: Run setup_ffmpeg (installer script in repo)
        run: |
          pwsh -NoProfile -ExecutionPolicy Bypass -File .\setup_ffmpeg.ps1
        shell: powershell

      - name: Run setup_wxwidgets (installer script in repo)
        run: |
          .\setup_wxwidgets.bat
        shell: cmd

      - name: Configure & build (CMake)
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DBUILD_TESTS=ON
          cmake --build build --config Release -- /m
        shell: powershell

      - name: Run unit tests
        run: |
          ctest --test-dir build -C Release --output-on-failure
        shell: powershell

      - name: Upload test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: windows-test-logs
          path: build/Testing/Temporary

      - name: Generate packages (CPack)
        run: |
          cmake --build build --config Release --target package
          pushd build
          cpack -C Release
          popd
        shell: powershell

      - name: Run TripSitter smoke test (launch GUI briefly)
        run: |
          Write-Host "Searching for TripSitter.exe..."
          $exe = Get-ChildItem -Recurse -File -Path build | Where-Object { $_.Name -eq 'TripSitter.exe' } | Select-Object -First 1 -ExpandProperty FullName
          if (-not $exe) {
            Write-Error "TripSitter.exe not found in build output"
            exit 1
          }
          Write-Host "Found: $exe"
          # Launch the GUI without args, wait briefly, ensure it stays running, then terminate
          $proc = Start-Process -FilePath $exe -PassThru
          Start-Sleep -Seconds 6
          if ($proc.HasExited) {
            Write-Error "TripSitter failed to stay running (exit code: $($proc.ExitCode))"
            exit 1
          }
          # Cleanly stop the process
          try {
            Stop-Process -Id $proc.Id -Force
          } catch {
            Write-Host "Failed to stop TripSitter process gracefully"
          }
          Write-Host "TripSitter smoke test passed"
        shell: powershell

      - name: List produced artifacts
        run: |
          Get-ChildItem -Recurse -File -Path build | Where-Object { $_.Extension -in '.zip', '.exe' } | Sort-Object Length -Descending | Select-Object -First 40 | Format-Table
        shell: powershell

      - name: Upload ZIP packages
        uses: actions/upload-artifact@v4
        with:
          name: trip-sitter-zip
          path: |
            build/*.zip
            build/**/*.zip
            build/bin/Release/*.zip

      - name: Upload installer packages
        uses: actions/upload-artifact@v4
        with:
          name: trip-sitter-installers
          path: |
            build/*.exe
            build/**/*.exe
            build/bin/Release/*.exe

  release-on-tag:
    name: Create GitHub Release (on tag)
    runs-on: ubuntu-latest
    needs: build-windows
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Download artifacts from build job
        uses: actions/download-artifact@v4
        with:
          name: trip-sitter-installers

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: build/bin/Release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
; NSIS Installer Template for MTV TripSitter
; This file is configured by CMake/CPack - variables use @VAR@ syntax

!include "MUI2.nsh"
!include "FileFunc.nsh"
!include "x64.nsh"

; Basic installer info (populated by CPack)
Name "@CPACK_NSIS_DISPLAY_NAME@"
OutFile "@CPACK_TOPLEVEL_DIRECTORY@/@CPACK_OUTPUT_FILE_NAME@"
InstallDir "$PROGRAMFILES64\@CPACK_PACKAGE_INSTALL_DIRECTORY@"
InstallDirRegKey HKLM "Software\@CPACK_PACKAGE_VENDOR@\@CPACK_PACKAGE_NAME@" "InstallDir"

; Request admin privileges (needed for Program Files installation)
RequestExecutionLevel admin

; Version info for Windows Explorer
VIProductVersion "@CPACK_PACKAGE_VERSION_MAJOR@.@CPACK_PACKAGE_VERSION_MINOR@.@CPACK_PACKAGE_VERSION_PATCH@.0"
VIAddVersionKey "ProductName" "@CPACK_PACKAGE_NAME@"
VIAddVersionKey "CompanyName" "@CPACK_PACKAGE_VENDOR@"
VIAddVersionKey "FileDescription" "@CPACK_PACKAGE_DESCRIPTION_SUMMARY@"
VIAddVersionKey "FileVersion" "@CPACK_PACKAGE_VERSION@"
VIAddVersionKey "LegalCopyright" "@PROJECT_COPYRIGHT_YEARS@ MTV"

; Modern UI configuration
!define MUI_ABORTWARNING
!define MUI_ICON "@CMAKE_SOURCE_DIR@\assets\icon.ico"
!define MUI_UNICON "@CMAKE_SOURCE_DIR@\assets\icon.ico"

; Header and welcome images (optional - can be added later)
; !define MUI_HEADERIMAGE
; !define MUI_HEADERIMAGE_BITMAP "@CMAKE_SOURCE_DIR@\assets\installer-header.bmp"
; !define MUI_WELCOMEFINISHPAGE_BITMAP "@CMAKE_SOURCE_DIR@\assets\installer-welcome.bmp"

; Installer pages
!insertmacro MUI_PAGE_WELCOME
!insertmacro MUI_PAGE_LICENSE "@CPACK_RESOURCE_FILE_LICENSE@"
!insertmacro MUI_PAGE_DIRECTORY
!insertmacro MUI_PAGE_INSTFILES
!define MUI_FINISHPAGE_RUN "$INSTDIR\bin\TripSitter.exe"
!define MUI_FINISHPAGE_RUN_TEXT "Launch MTV TripSitter"
!insertmacro MUI_PAGE_FINISH

; Uninstaller pages
!insertmacro MUI_UNPAGE_CONFIRM
!insertmacro MUI_UNPAGE_INSTFILES

; Language
!insertmacro MUI_LANGUAGE "English"

; Installer section
Section "MTV TripSitter" SecMain
    SetOutPath "$INSTDIR"

    ; Install all files (CPack populates this)
    @CPACK_NSIS_FULL_INSTALL@

    ; Install TensorRT runtime DLLs for RTX GPU acceleration (if available)
    ; These are optional - app falls back to CUDA EP on GTX cards or if missing
    SetOutPath "$INSTDIR\bin"
    IfFileExists "@TENSORRT_DLL_DIR@\nvinfer_10.dll" 0 skip_tensorrt
        File /nonfatal "@TENSORRT_DLL_DIR@\nvinfer_10.dll"
        File /nonfatal "@TENSORRT_DLL_DIR@\nvinfer_lean_10.dll"
        File /nonfatal "@TENSORRT_DLL_DIR@\nvinfer_plugin_10.dll"
        File /nonfatal "@TENSORRT_DLL_DIR@\nvinfer_dispatch_10.dll"
        File /nonfatal "@TENSORRT_DLL_DIR@\nvonnxparser_10.dll"
    skip_tensorrt:

    ; Install AudioFlux DLLs for spectral analysis (if available)
    ; These are optional - Flux mode falls back to Energy mode if missing
    IfFileExists "@AUDIOFLUX_DLL_DIR@\audioflux.dll" 0 skip_audioflux
        File /nonfatal "@AUDIOFLUX_DLL_DIR@\audioflux.dll"
        File /nonfatal "@AUDIOFLUX_FFTW_DLL@"
    skip_audioflux:

    ; Install ONNX models for AI beat detection
    SetOutPath "$INSTDIR\models"
    File /nonfatal "@CMAKE_SOURCE_DIR@\models\*.onnx"

    ; Install UI resources (fonts, images)
    SetOutPath "$INSTDIR\resources"
    File /nonfatal "@CMAKE_SOURCE_DIR@\unreal-prototype\Source\TripSitter\Resources\wallpaper.png"
    File /nonfatal "@CMAKE_SOURCE_DIR@\unreal-prototype\Source\TripSitter\Resources\TitleHeader.png"
    File /nonfatal "@CMAKE_SOURCE_DIR@\unreal-prototype\Source\TripSitter\Resources\icon.png"
    File /nonfatal "@CMAKE_SOURCE_DIR@\unreal-prototype\Source\TripSitter\Resources\Corpta.otf"
    File /nonfatal "@CMAKE_SOURCE_DIR@\unreal-prototype\Source\TripSitter\Resources\TripSitter.ico"

    ; Install license files
    SetOutPath "$INSTDIR\licenses"
    File "@CMAKE_SOURCE_DIR@\LICENSE"
    File /nonfatal "@CMAKE_SOURCE_DIR@\THIRD_PARTY_LICENSES.md"

    ; Install changelog
    SetOutPath "$INSTDIR"
    File /nonfatal "@CMAKE_SOURCE_DIR@\CHANGELOG.md"

    ; Create uninstaller
    WriteUninstaller "$INSTDIR\Uninstall.exe"

    ; Registry entries for Add/Remove Programs
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\@CPACK_PACKAGE_NAME@" \
        "DisplayName" "@CPACK_NSIS_DISPLAY_NAME@"
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\@CPACK_PACKAGE_NAME@" \
        "UninstallString" "$INSTDIR\Uninstall.exe"
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\@CPACK_PACKAGE_NAME@" \
        "DisplayIcon" "$INSTDIR\bin\TripSitter.exe"
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\@CPACK_PACKAGE_NAME@" \
        "Publisher" "@CPACK_PACKAGE_VENDOR@"
    WriteRegStr HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\@CPACK_PACKAGE_NAME@" \
        "DisplayVersion" "@CPACK_PACKAGE_VERSION@"
    WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\@CPACK_PACKAGE_NAME@" \
        "NoModify" 1
    WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\@CPACK_PACKAGE_NAME@" \
        "NoRepair" 1

    ; Get installed size
    ${GetSize} "$INSTDIR" "/S=0K" $0 $1 $2
    WriteRegDWORD HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\@CPACK_PACKAGE_NAME@" \
        "EstimatedSize" $0

    ; Store install directory
    WriteRegStr HKLM "Software\@CPACK_PACKAGE_VENDOR@\@CPACK_PACKAGE_NAME@" "InstallDir" "$INSTDIR"
SectionEnd

; Start Menu shortcuts section
Section "Start Menu Shortcuts" SecStartMenu
    CreateDirectory "$SMPROGRAMS\@CPACK_NSIS_DISPLAY_NAME@"
    CreateShortCut "$SMPROGRAMS\@CPACK_NSIS_DISPLAY_NAME@\@CPACK_NSIS_DISPLAY_NAME@.lnk" "$INSTDIR\bin\TripSitter.exe"
    CreateShortCut "$SMPROGRAMS\@CPACK_NSIS_DISPLAY_NAME@\Uninstall.lnk" "$INSTDIR\Uninstall.exe"
SectionEnd

; Desktop shortcut section (optional)
Section "Desktop Shortcut" SecDesktop
    CreateShortCut "$DESKTOP\@CPACK_NSIS_DISPLAY_NAME@.lnk" "$INSTDIR\bin\TripSitter.exe"
SectionEnd

; Uninstaller section
Section "Uninstall"
    ; Remove Start Menu shortcuts
    Delete "$SMPROGRAMS\@CPACK_NSIS_DISPLAY_NAME@\*.lnk"
    RMDir "$SMPROGRAMS\@CPACK_NSIS_DISPLAY_NAME@"

    ; Remove Desktop shortcut
    Delete "$DESKTOP\@CPACK_NSIS_DISPLAY_NAME@.lnk"

    ; Remove TensorRT DLLs (if installed)
    Delete "$INSTDIR\bin\nvinfer_10.dll"
    Delete "$INSTDIR\bin\nvinfer_lean_10.dll"
    Delete "$INSTDIR\bin\nvinfer_plugin_10.dll"
    Delete "$INSTDIR\bin\nvinfer_dispatch_10.dll"
    Delete "$INSTDIR\bin\nvonnxparser_10.dll"

    ; Remove AudioFlux DLLs (if installed)
    Delete "$INSTDIR\bin\audioflux.dll"
    Delete "$INSTDIR\bin\libfftw3f-3.dll"

    ; Remove ONNX models
    Delete "$INSTDIR\models\*.onnx"
    RMDir "$INSTDIR\models"

    ; Remove UI resources
    Delete "$INSTDIR\resources\wallpaper.png"
    Delete "$INSTDIR\resources\TitleHeader.png"
    Delete "$INSTDIR\resources\icon.png"
    Delete "$INSTDIR\resources\Corpta.otf"
    Delete "$INSTDIR\resources\TripSitter.ico"
    RMDir "$INSTDIR\resources"

    ; Remove license files
    Delete "$INSTDIR\licenses\LICENSE"
    Delete "$INSTDIR\licenses\THIRD_PARTY_LICENSES.md"
    RMDir "$INSTDIR\licenses"

    ; Remove changelog
    Delete "$INSTDIR\CHANGELOG.md"

    ; Remove files (CPack populates this)
    @CPACK_NSIS_DELETE_FILES@
    @CPACK_NSIS_DELETE_DIRECTORIES@

    ; Remove runtime/user data (logs, configs, etc.)
    ; Remove logs/configs under $INSTDIR if present
    IfFileExists "$INSTDIR\logs\*.*" 0 +2
        Delete "$INSTDIR\logs\*.*"
    IfDirExists "$INSTDIR\logs" 0 +2
        RMDir /r "$INSTDIR\logs"
    IfFileExists "$INSTDIR\config\*.*" 0 +2
        Delete "$INSTDIR\config\*.*"
    IfDirExists "$INSTDIR\config" 0 +2
        RMDir /r "$INSTDIR\config"

    ; Remove per-user data (prompt before deletion)
    IfDirExists "$APPDATA\@CPACK_PACKAGE_VENDOR@\@CPACK_PACKAGE_NAME@" 0 skip_user_remove
        MessageBox MB_YESNO|MB_ICONQUESTION "Remove user data under $APPDATA\\@CPACK_PACKAGE_VENDOR@\\@CPACK_PACKAGE_NAME@?\nThis will permanently delete logs and configuration files." IDNO skip_user_remove
        RMDir /r "$APPDATA\@CPACK_PACKAGE_VENDOR@\@CPACK_PACKAGE_NAME@"
    skip_user_remove:

    ; Remove per-machine data (prompt before deletion)
    IfDirExists "$PROGRAMDATA\@CPACK_PACKAGE_VENDOR@\@CPACK_PACKAGE_NAME@" 0 skip_machine_remove
        MessageBox MB_YESNO|MB_ICONQUESTION "Remove machine-wide data under $PROGRAMDATA\\@CPACK_PACKAGE_VENDOR@\\@CPACK_PACKAGE_NAME@?\nThis will permanently delete shared logs and data." IDNO skip_machine_remove
        RMDir /r "$PROGRAMDATA\@CPACK_PACKAGE_VENDOR@\@CPACK_PACKAGE_NAME@"
    skip_machine_remove:

    ; Remove uninstaller
    Delete "$INSTDIR\Uninstall.exe"

    ; Remove install directory if empty
    RMDir "$INSTDIR"

    ; Remove registry entries
    DeleteRegKey HKLM "Software\Microsoft\Windows\CurrentVersion\Uninstall\@CPACK_PACKAGE_NAME@"
    DeleteRegKey HKLM "Software\@CPACK_PACKAGE_VENDOR@\@CPACK_PACKAGE_NAME@"
SectionEnd

; Section descriptions
!insertmacro MUI_FUNCTION_DESCRIPTION_BEGIN
    !insertmacro MUI_DESCRIPTION_TEXT ${SecMain} "Core application files (required)"
    !insertmacro MUI_DESCRIPTION_TEXT ${SecStartMenu} "Create Start Menu shortcuts"
    !insertmacro MUI_DESCRIPTION_TEXT ${SecDesktop} "Create Desktop shortcut"
!insertmacro MUI_FUNCTION_DESCRIPTION_END
